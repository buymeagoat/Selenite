name: Coverage Report

on:
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install deps and run coverage
        run: |
          cd frontend
          npm ci
          npm run test:coverage -- --config vitest.config.coverage.mjs
      - name: Read coverage summary
        id: cov
        run: |
          node - <<'NODE'
const fs = require('fs');
const path = require('path');
const summaryPath = path.join('frontend', 'coverage', 'coverage-summary.json');
if (!fs.existsSync(summaryPath)) {
  console.log('summary_present=false');
  return;
}
const data = JSON.parse(fs.readFileSync(summaryPath, 'utf-8'));
const lines = data.total.lines.pct;
const statements = data.total.statements.pct;
const functions = data.total.functions.pct;
const branches = data.total.branches.pct;
const payload = { lines, statements, functions, branches };
fs.writeFileSync('coverage-summary.txt', JSON.stringify(payload, null, 2));
console.log(`summary_present=true`);
NODE
      - name: Post coverage comment
        if: steps.cov.outputs.summary_present != 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- coverage-report -->';
            const summary = require(`${process.env.GITHUB_WORKSPACE}/coverage-summary.txt`);
            const body = `${marker}
Frontend coverage:
- Lines: ${summary.lines}%
- Statements: ${summary.statements}%
- Functions: ${summary.functions}%
- Branches: ${summary.branches}%`;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body && c.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
