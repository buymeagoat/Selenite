name: QA Gateway - CI Validation

'on':
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  backend-qa:
    name: Backend Quality Checks
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: production
      DISABLE_FILE_LOGS: "1"
      ALLOW_LOCALHOST_CORS: "1"
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-minimal.txt
          pip install black ruff pytest pytest-cov pytest-asyncio httpx
      
      - name: Code formatting check (black)
        working-directory: ./backend
        run: python -m black app/ tests/ --check
      
      - name: Linting check (ruff)
        working-directory: ./backend
        run: python -m ruff check app/ tests/
      
      - name: Run tests with coverage
        working-directory: ./backend
        run: |
          python -m pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing
      
      - name: Coverage threshold check
        working-directory: ./backend
        run: |
          coverage=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(float(root.attrib['line-rate']) * 100)")
          echo "Coverage: $coverage%"
          if (( $(echo "$coverage < 80" | bc -l) )); then
            echo "❌ Coverage below 80% threshold"
            exit 1
          fi
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
      
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: backend/pytest-report.xml

  frontend-qa:
    name: Frontend Quality Checks
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production
      VITE_API_URL: http://127.0.0.1:8200
      ALLOW_LOCALHOST_CORS: "1"
    strategy:
      matrix:
        node-version: ['20']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Type checking (TypeScript)
        working-directory: ./frontend
        run: npm run type-check
      
      - name: Linting check (ESLint)
        working-directory: ./frontend
        run: npm run lint
      
      - name: Run tests with coverage
        working-directory: ./frontend
        run: npm run test:coverage
      
      - name: Coverage threshold check
        working-directory: ./frontend
        run: |
          coverage=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
          echo "Coverage: $coverage%"
          if (( $(echo "$coverage < 70" | bc -l) )); then
            echo "❌ Coverage below 70% threshold"
            exit 1
          fi
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage
      
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-results
          path: frontend/test-results/

  e2e-smoke:
    name: E2E Smoke Tests
    runs-on: ubuntu-latest
    needs: [backend-qa, frontend-qa]
    env:
      ENVIRONMENT: production
      ALLOW_LOCALHOST_CORS: "1"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-minimal.txt
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install --with-deps chromium
      
      - name: Run smoke E2E tests
        working-directory: ./frontend
        run: npm run e2e:ci -- --grep "@smoke"
      
      - name: Upload E2E results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-smoke-results
          path: |
            frontend/playwright-report/
            frontend/test-results/

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Backend security audit
        working-directory: ./backend
        run: |
          pip install pip-audit
          pip-audit -r requirements-minimal.txt
      
      - name: Frontend security audit
        working-directory: ./frontend
        run: npm audit --audit-level=moderate
