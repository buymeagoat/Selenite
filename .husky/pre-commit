#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Selenite QA Gateway - Pre-Commit Hook
# Enforces code quality standards before allowing commits

set -e

echo "üîç Selenite QA Gateway: Pre-Commit Validation"
echo "=============================================="

# Check if SKIP_QA is set (emergency bypass)
if [ -n "$SKIP_QA" ]; then
  echo "‚ö†Ô∏è  WARNING: QA checks bypassed via SKIP_QA environment variable"
  echo "   This should only be used in emergencies!"
  exit 0
fi

# Stage 1: Commit Message Validation
echo ""
echo "üìù Stage 1: Commit Message Format"
COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
if [ -f "$COMMIT_MSG_FILE" ]; then
  COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
  if ! echo "$COMMIT_MSG" | grep -qE '^\[.+\] .{10,}'; then
    echo "‚ùå FAILED: Commit message must follow format: [Component] Description (min 10 chars)"
    echo "   Example: [Frontend/Dashboard] Add job filtering by status"
    exit 1
  fi
  if echo "$COMMIT_MSG" | grep -qiE '\b(wip|fixup|temp|test|todo)\b'; then
    echo "‚ùå FAILED: Commit message contains temporary markers (WIP, fixup, temp, test, TODO)"
    echo "   Please use meaningful commit messages"
    exit 1
  fi
  echo "‚úÖ Commit message format valid"
fi

# Stage 2: Backend Quality Checks
if git diff --cached --name-only | grep -qE '^backend/'; then
  echo ""
  echo "üêç Stage 2: Backend Quality Checks"
  
  cd backend
  
  # Check if virtual environment is activated
  if [ -z "$VIRTUAL_ENV" ]; then
    if [ -f ".venv/Scripts/activate" ]; then
      . .venv/Scripts/activate
    elif [ -f ".venv/bin/activate" ]; then
      . .venv/bin/activate
    else
      echo "‚ö†Ô∏è  Virtual environment not found or activated"
      echo "   Run: python -m venv .venv && source .venv/bin/activate"
      exit 1
    fi
  fi
  
  # Code formatting check
  echo "  ‚Üí Checking code formatting (black)..."
  if ! python -m black app/ tests/ --check --quiet 2>/dev/null; then
    echo "‚ùå FAILED: Code formatting issues detected"
    echo "   Fix with: cd backend && black app/ tests/"
    exit 1
  fi
  echo "  ‚úÖ Code formatting OK"
  
  # Linting check
  echo "  ‚Üí Running linter (ruff)..."
  if ! python -m ruff check app/ tests/ --quiet 2>/dev/null; then
    echo "‚ùå FAILED: Linting issues detected"
    echo "   Fix with: cd backend && ruff check app/ tests/ --fix"
    exit 1
  fi
  echo "  ‚úÖ Linting OK"
  
  # Run tests for changed files
  echo "  ‚Üí Running unit tests..."
  CHANGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^backend/.*\.py$' | sed 's/^backend\///' || true)
  if [ -n "$CHANGED_PY_FILES" ]; then
    if ! python -m pytest -x --tb=short -q 2>/dev/null; then
      echo "‚ùå FAILED: Unit tests failed"
      echo "   Fix tests before committing"
      exit 1
    fi
    echo "  ‚úÖ Unit tests passed"
  else
    echo "  ‚è≠Ô∏è  No Python files changed, skipping tests"
  fi
  
  cd ..
fi

# Stage 3: Frontend Quality Checks
if git diff --cached --name-only | grep -qE '^frontend/'; then
  echo ""
  echo "‚öõÔ∏è  Stage 3: Frontend Quality Checks"
  
  cd frontend
  
  # Type checking
  echo "  ‚Üí Type checking (TypeScript)..."
  if ! npm run type-check --silent 2>/dev/null; then
    echo "‚ùå FAILED: TypeScript type errors detected"
    echo "   Fix type errors before committing"
    exit 1
  fi
  echo "  ‚úÖ Type checking OK"
  
  # Linting check
  echo "  ‚Üí Running linter (ESLint)..."
  if ! npm run lint --silent 2>/dev/null; then
    echo "‚ùå FAILED: ESLint issues detected"
    echo "   Fix with: cd frontend && npm run lint"
    exit 1
  fi
  echo "  ‚úÖ Linting OK"
  
  # Run unit tests
  echo "  ‚Üí Running unit tests..."
  CHANGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^frontend/src/.*\.(ts|tsx)$' || true)
  if [ -n "$CHANGED_TS_FILES" ]; then
    if ! npm run test --silent 2>/dev/null; then
      echo "‚ùå FAILED: Unit tests failed"
      echo "   Fix tests before committing"
      exit 1
    fi
    echo "  ‚úÖ Unit tests passed"
  else
    echo "  ‚è≠Ô∏è  No TypeScript files changed, skipping tests"
  fi
  
  cd ..
fi

# Stage 4: Documentation Check
echo ""
echo "üìö Stage 4: Documentation Validation"
CHANGED_FILES=$(git diff --cached --name-only)

# Check if API contracts were modified
if echo "$CHANGED_FILES" | grep -qE 'backend/app/routes/'; then
  if ! echo "$CHANGED_FILES" | grep -qE 'docs/API_CONTRACTS.md'; then
    echo "‚ö†Ô∏è  WARNING: API routes modified but docs/API_CONTRACTS.md not updated"
    echo "   Consider updating API documentation"
    # Don't fail, just warn
  fi
fi

# Check if components were modified
if echo "$CHANGED_FILES" | grep -qE 'frontend/src/components/'; then
  if ! echo "$CHANGED_FILES" | grep -qE 'docs/COMPONENT_SPECS.md'; then
    echo "‚ö†Ô∏è  WARNING: Components modified but docs/COMPONENT_SPECS.md not updated"
    echo "   Consider updating component documentation"
    # Don't fail, just warn
  fi
fi

echo "  ‚úÖ Documentation check complete"

# Final Summary
echo ""
echo "=============================================="
echo "‚úÖ All QA checks passed! Proceeding with commit..."
echo ""
echo "üí° Tip: Run 'npm run qa' or 'make qa' to run full validation suite"
echo ""

exit 0
